substitutions:
  card_height: 120
  sensors_card_height: 100

api:
  id: main_api
  on_client_connected:
    then:
      - script.execute: update_connection_status
  on_client_disconnected: 
    then:
      - script.execute: update_connection_status

### Sensors

time:
  - platform: homeassistant
    id: homeassistant_time
    timezone: "Europe/Paris"
    on_time:
      - hours: 2,3,4,5
        minutes: 5
        seconds: 0
        then:
          - switch.turn_on: switch_antiburn
      - hours: 2,3,4,5
        minutes: 35
        seconds: 0
        then:
          - switch.turn_off: switch_antiburn
      - minutes: '*'
        seconds: 0
        then:
           - lvgl.label.update:
              id: time_label
              text:
                time_format: "%R"
                time: homeassistant_time
           - lambda: |-
              char date_buf[30];
              time_t now = id(homeassistant_time).now().timestamp;
              struct tm* timeinfo = localtime(&now);
              
              // Tableaux de traduction
              const char* jours[] = {"Dimanche", "Lundi", "Mardi", "Mercredi", 
                                     "Jeudi", "Vendredi", "Samedi"};
              const char* mois[] = {"janvier", "février", "mars", "avril", "mai", "juin",
                                    "juillet", "août", "septembre", "octobre", "novembre", "décembre"};
              
              // Format: Jour DD Mois Année
              snprintf(date_buf, sizeof(date_buf), "%s %02d %s %04d", 
                jours[timeinfo->tm_wday],
                timeinfo->tm_mday,
                mois[timeinfo->tm_mon],
                timeinfo->tm_year + 1900
              );

              lv_label_set_text(id(date_label), date_buf);


light:
  - id: !extend ${light}
    on_turn_on: 
      then: 
        - lvgl.widget.update: 
            id: [light_btn, light_icon]
            state: 
              checked: true
        - lvgl.widget.show: [light_state_on, light_touch_for_text_on]
        - lvgl.widget.hide: [light_state_off, light_touch_for_text_off]
    on_turn_off: 
      then: 
        - lvgl.widget.update: 
            id: [light_btn, light_icon]
            state: 
              checked: false
        - lvgl.widget.show: [light_state_off, light_touch_for_text_off]
        - lvgl.widget.hide: [light_state_on, light_touch_for_text_on]

sensor:
  - platform: homeassistant
    entity_id: ${room_temperature_entity_id}
    id: temperature
    on_value:
      - lvgl.label.update:
          id: temp_value
          text:
            format: "%.1f°"
            args: [ 'x' ]  

  - platform: homeassistant
    id: room_humidity
    entity_id: ${room_humidity_entity_id}
    on_value:
      - lvgl.label.update:
          id: humidity_value
          text:
            format: "%.0f%%"
            args: [ 'x' ]
  
  - platform: homeassistant
    id: climate_target_temp
    entity_id: ${climate_entity_id}
    attribute: temperature
    on_value:
      - lvgl.label.update:
          id: target_temp_display
          text:
            format: "%.1f°"
            args: [ 'x' ]  


text_sensor:
  - platform: homeassistant
    id: climate_action
    entity_id: ${climate_entity_id}
    attribute: hvac_action
    on_value: 
      then: 
        if: 
          condition:
            text_sensor.state:
              id: climate_action
              state: 'off'
          then: 
            - lvgl.widget.show: [heat_state_off]
            - lvgl.widget.hide: [heat_state_idle, heat_state_heating]
          else: 
            if: 
              condition:
                text_sensor.state:
                  id: climate_action
                  state: 'idle'
              then: 
                - lvgl.widget.show: [heat_state_idle]
                - lvgl.widget.hide: [heat_state_off, heat_state_heating]
              else: 
                - lvgl.widget.show: [heat_state_heating]
                - lvgl.widget.hide: [heat_state_off, heat_state_idle]
  - platform: homeassistant
    id: climate_mode
    entity_id: ${climate_entity_id}
    on_value: 
      then: 
        if: 
          condition:
            text_sensor.state:
              id: climate_mode
              state: 'off'
          then: 
            - lvgl.widget.update:   
                id: [heat_icon_btn, heat_icon]
                state: 
                  checked: false
          else: 
            - lvgl.widget.update:   
                id: [heat_icon_btn, heat_icon]
                state: 
                  checked: true

# Scripts

script:
  - id: update_connection_status
    then:
      - delay: 5s # api.connected without some wait
      - if: 
          condition: 
              api.connected:
                  state_subscription_only: true
          then: 
            - lvgl.led.update:
                id: connection_dot
                color: 0x22c55e
          else:
            - lvgl.led.update:
                id: connection_dot
                color: 0xef4444
  - id: power_off_screen
    then: 
      - script.execute: fade_out_backlight
      - script.wait: fade_out_backlight
      - lvgl.pause:
          show_snow: false


switch:
  - platform: template
    name: Antiburn
    id: switch_antiburn
    icon: mdi:television-shimmer
    optimistic: true
    entity_category: "config"
    turn_on_action:
      - logger.log: "Starting Antiburn"
      - if:
          condition:
            lvgl.is_idle:
              timeout: 30s
          then:
            - lvgl.pause:
                show_snow: true
    turn_off_action:
      - logger.log: "Stopping Antiburn"
      - if:
          condition: lvgl.is_paused
          then:
            - lvgl.pause:
                show_snow: false
  - platform: template
    name: Screen Always ON
    id: screen_always_on
    icon: mdi:home-lightbulb
    optimistic: true
    entity_category: "config"
    # No turn on action to avoid on screen during bed time
    turn_off_action:
      - if:
          condition:
            lvgl.is_idle:
              timeout: 30s
          then:
            - script.execute: power_off_screen

### LVGL

lvgl:
  - id: main_lvgl
    on_idle:
      - timeout: 50s
        then: 
          - lvgl.page.show: main_page
      - timeout: 60s
        then: 
          - if:
              condition:
                switch.is_off: screen_always_on
              then:
                - script.execute: power_off_screen
    on_resume: 
      then: 
        - lvgl.widget.redraw:
        - script.execute: fade_in_backlight
        # Stop antiburn if it's activated
        - if:
            condition:
              switch.is_on: switch_antiburn
            then:
              switch.turn_off: switch_antiburn



    style_definitions:
      - id: shared_card
        border_width: 1
        radius: 8
        shadow_width: 2
        shadow_ofs_y: 2
        shadow_ofs_x: 2
        shadow_color: 0x000000
        shadow_opa: 40%
        pad_all: 12
        bg_opa: cover
      - id: sensor_container
        height: 80
      - id: button_card
        width: 100%
        height: ${card_height}
        bg_color: 0x1f2937  # Gray-800 (off state)
        border_color: 0x1f2937
      - id: plus_minus_btn
        bg_color: 0x374151  # Gray-700
        border_width: 0
        radius: 6
        pad_all: 4
      - id: light_state_x
        text_font: montserrat_eu_16
        text_align: LEFT
      - id: light_touch_for_x
        border_width: 1
        radius: 6
        text_font: montserrat_eu_16
        text_align: CENTER
        pad_right: 10
        pad_left: 10
        pad_top: 4
        pad_bottom: 4
        bg_opa: cover
      - id: temp_hum_sensor_icon
        text_font: material_icons_48
      - id: temp_hum_sensor_value
        text_font: montserrat_eu_40
        text_align: CENTER
      - id: heat_state_x
        text_font: montserrat_eu_16
        text_align: LEFT


    top_layer:
        widgets:
          - container:
              id: header
              width: 480
              height: 100
              align: TOP_MID
              bg_color: 0x1f1f1f
              bg_opa: COVER
              border_width: 0
              border_color: 0x2d2d2d
              pad_all: 12
              scrollable: false
              widgets:
                - button:
                    id: power_btn
                    width: 32
                    height: 32
                    y: -5
                    bg_opa: TRANSP
                    border_side: NONE
                    outline_width: 0
                    shadow_width: 0
                    pad_all: 0
                    on_press: 
                      then: 
                        - script.execute: power_off_screen
                    
                    widgets:
                      - label:
                          text: "\U000F0425"  # Power icon
                          text_color: 0x6b7280
                          text_font: material_icons_32

                # Heure
                - label:
                    id: time_label
                    text: "--:--"
                    align: CENTER
                    y: 0
                    text_font: montserrat_eu_48
                    text_color: 0xf3f4f6
                    text_align: CENTER
                    on_click:
                      then: 
                        - lvgl.page.show: main_page
                
                # Date
                - label:
                    id: date_label
                    text: " "
                    align: CENTER
                    y: 35
                    text_font: montserrat_eu_16
                    text_color: 0x6b7280
                    text_align: CENTER

                # Connection indicator dot (right)
                - led:
                    id: connection_dot
                    width: 8
                    height: 8
                    x: 450
                    brightness: 100%
                    color: 0xef4444
                    on_click:
                      then: 
                        - lvgl.page.show: config_page

    page_wrap: true
    pages:
      ###########################
      ####### HOME PAGE #########
      ###########################
      - id: main_page
        # skip: true
        width: 100%
        bg_color: 0x0f0f0f
        bg_opa: cover
        pad_top: 110
        pad_bottom: 10
        pad_left: 8
        pad_right: 8
        layout:
          type: FLEX
          flex_flow: COLUMN
          flex_align_main: START
          flex_align_cross: CENTER
          pad_row: 10
        widgets:
          # Light
          - button:
              id: light_btn
              state:
                checked: false
              styles: [shared_card, button_card]
              layout: 
                type: FLEX
                flex_flow: ROW
                flex_align_main: SPACE_BETWEEN
                flex_align_cross: CENTER
              checked:
                bg_color: 0xb45309
                border_color: 0xd97706
              on_click:
                then: 
                  - light.toggle:
                      id: ${light}
              widgets:
                # Left side: Icon + Label
                - container:
                    width: 160
                    scrollable: false
                    clickable: false # Propagate to parent
                    layout: 
                      type: FLEX
                      flex_flow: ROW
                      flex_align_main: START
                      flex_align_cross: CENTER
                      pad_column: 8
                    widgets: 
                      - label:
                          id: light_icon
                          text: "\U000F0335"  # Lightbulb icon
                          text_color: "0xa1a5b0"  # Gray-600
                          text_font: material_icons_48
                          clickable: false # Propagate to parent
                          state:
                            checked: false
                          checked:
                            text_color: 0xfcd34d
                      # Text group
                      - container:
                          width: 120
                          clickable: false # Propagate to parent
                          layout: 
                            type: FLEX
                            flex_flow: COLUMN
                            flex_align_main: CENTER
                          widgets:
                            - label:
                                id: light_label
                                text: "Lumière"
                                text_color: "0xf3f4f6"  # Gray-100
                                text_font: montserrat_eu_20
                                text_align: LEFT
                                clickable: false # Propagate to parent
                            - label:
                                id: light_state_off
                                styles: light_state_x
                                text: "Éteinte" 
                                text_color: "0x9ca3af"  # Gray-400
                                clickable: false # Propagate to parent
                            - label:
                                id: light_state_on
                                styles: light_state_x
                                text: "Allumée"
                                hidden: true
                                text_color: 0xFDE047
                                clickable: false # Propagate to parent
                # Right side: Status indicator text
                - label:
                    id: light_touch_for_text_off
                    styles: light_touch_for_x
                    bg_color: 0x1f2937  # Gray-800
                    border_color: 0x2d3748  # Gray-700
                    text: "Toucher pour allumer"  # Sans accents
                    text_color: 0x9ca3af  # Gray-400
                    clickable: false # Propagate to parent
                - label:
                    id: light_touch_for_text_on
                    styles: light_touch_for_x
                    hidden: true
                    bg_color: 0xFFFFFF  # White
                    border_color: 0xFFFFFF  # White
                    text: "Toucher pour éteindre"  # Sans accents
                    text_color: 0xB45309
                    clickable: false # Propagate to parent
          # Grid sensor
          - container:
              id: sensors_grid
              width: 100%
              height: ${sensors_card_height}
              layout: 
                type: FLEX
                flex_flow: ROW
                flex_align_main: SPACE_BETWEEN
                flex_align_cross: CENTER
                pad_column: 8
              widgets: 
                # Temperature card
                - container: 
                    id: temp_card
                    styles: [shared_card, sensor_container]
                    bg_color: 0x7c2d12 # Red-900
                    border_color: 0x92400e  # Orange-900
                    flex_grow: 1
                    layout: 
                      type: FLEX
                      flex_flow: ROW
                      flex_align_main: SPACE_BETWEEN
                      flex_align_cross: CENTER
                      flex_align_track: CENTER
                    widgets: 
                      - label:
                          styles: temp_hum_sensor_icon
                          text: "\U000F050F"
                          text_color: "0xfed7aa"  # Orange-200
                      - label:
                          id: temp_value
                          styles: temp_hum_sensor_value
                          text: "--.-°"
                          text_color: "0xfef3c7"  # Amber-100
                # Humidity card
                - container: 
                    id: humidity_card
                    styles: [shared_card, sensor_container]
                    bg_color: 0x0c4a6e  # Blue-900
                    border_color: 0x164e63  # Cyan-900
                    flex_grow: 1
                    layout: 
                      type: FLEX
                      flex_flow: ROW
                      flex_align_main: SPACE_BETWEEN
                      flex_align_cross: CENTER
                      flex_align_track: CENTER
                    widgets: 
                      - label:
                          styles: temp_hum_sensor_icon
                          text: "\U000F058E"
                          text_color: 0xa5f3fc  # Cyan-300
                      - label:
                          id: humidity_value
                          styles: temp_hum_sensor_value
                          text: "--%"
                          text_color: 0xa5f3fc  # Cyan-300
          # Climate
          - container:
              id: heating_btn
              styles: [shared_card, button_card]
              height: ${card_height}
              layout: 
                type: FLEX
                flex_flow: ROW
                flex_align_main: SPACE_BETWEEN
                flex_align_cross: CENTER
              widgets: 
                # Flame icon button
                - container:
                    flex_grow: 1
                    layout: 
                      type: FLEX
                      flex_flow: ROW
                      flex_align_main: START
                      flex_align_cross: CENTER
                      pad_column: 12
                    on_press: # On all block icon + label to have better cliking experience
                      then: 
                        - homeassistant.action:
                            action: climate.toggle
                            data:
                              entity_id: ${climate_entity_id}
                    widgets: 
                      - container:
                          id: heat_icon_btn
                          height: 60 # Icon size + 2 x padding
                          width: 60
                          state:
                            checked: false
                          bg_color: 0x374151 # Off state
                          bg_opa: cover
                          shadow_width: 2
                          border_width: 0
                          radius: 8
                          pad_all: 6
                          scrollable: false
                          clickable: false # Propagate to parent
                          layout: 
                            type: FLEX
                            flex_align_main: CENTER
                            flex_align_cross: CENTER
                          checked: 
                            bg_color: 0xEA580C
                          widgets: 
                            - label:
                                id: heat_icon
                                text: "\U000F0238"  # Heater icon
                                text_color: 0x6b7280 # Idle
                                text_font: material_icons_48
                                clickable: false # Propagate to parent
                                state:
                                  checked: false
                                checked: 
                                  text_color: 0xfef3c7
                      # Text group
                      - container:
                          width: 120
                          layout: 
                            type: FLEX
                            flex_flow: COLUMN
                            flex_align_main: CENTER
                          clickable: false # Propagate to parent
                          widgets:
                            - label:
                                id: heat_label
                                text: "Chauffage"
                                text_color: 0xf3f4f6  # Gray-100
                                text_font: montserrat_eu_20
                                text_align: LEFT
                                clickable: false # Propagate to parent
                            - label:
                                id: heat_state_off
                                styles: heat_state_x
                                text: "Éteint" 
                                text_color: 0x6b7280  # Gray-500
                                clickable: false # Propagate to parent
                            - label:
                                id: heat_state_idle
                                styles: heat_state_x
                                text: "Maintien"
                                hidden: true
                                text_color: 0xfb923c # Orange-400
                                clickable: false # Propagate to parent
                            - label:
                                id: heat_state_heating
                                styles: heat_state_x
                                text: "Chauffe"
                                hidden: true
                                text_color: 0xf59e0b # Amber-500
                                clickable: false # Propagate to parent
                # Temperature controls
                - container:
                    flex_grow: 1
                    layout: 
                      type: FLEX
                      flex_flow: ROW
                      flex_align_main: END
                      flex_align_cross: CENTER
                      flex_align_track: CENTER
                      pad_column: 8
                    widgets:
                      - button:
                          id: temp_minus_btn
                          styles: plus_minus_btn
                          layout: 
                            type: FLEX
                            flex_align_main: CENTER
                            flex_align_cross: CENTER
                            flex_align_track: CENTER
                          widgets: 
                            - label:
                                text: "\U000F1639"
                                text_color: 0x9ca3af  # Gray-400
                                text_font: material_icons_48
                                clickable: false # Propagate to parent
                          on_click: 
                            then: 
                            - homeassistant.action:
                                action: climate.set_temperature
                                data:
                                  entity_id: ${climate_entity_id}
                                  temperature: !lambda |-
                                    return std::max(id(climate_target_temp).state - 0.5, ${min_target_temperature});
                                  
                      - label:
                          id: target_temp_display
                          text: "--.-°"
                          text_color: 0xf3f4f6  # Gray-100
                          text_font: montserrat_eu_28
                          text_align: CENTER
                          width: 75 # Avoid blink in temp width changes
                      - button:
                          id: temp_plus_btn
                          styles: plus_minus_btn
                          layout: 
                            type: FLEX
                            flex_align_main: CENTER
                            flex_align_cross: CENTER
                            flex_align_track: CENTER
                          widgets: 
                            - label:
                                text: "\U000F11EC"
                                text_color: 0x9ca3af  # Gray-400
                                text_font: material_icons_48
                                clickable: false # Propagate to parent
                          on_click: 
                            then: 
                            - homeassistant.action:
                                action: climate.set_temperature
                                data:
                                  entity_id: ${climate_entity_id}
                                  temperature: !lambda |-
                                    return std::min(id(climate_target_temp).state + 0.5, ${max_target_temperature});
      ###########################
      ###### CONFIG PAGE ########
      ###########################
      - id: config_page
        skip: true
        width: 100%
        bg_color: 0x0f0f0f
        bg_opa: cover
        pad_top: 110
        pad_bottom: 10
        pad_left: 8
        pad_right: 8


font:
  - file:
      type: gfonts
      family: Montserrat
    id: montserrat_eu_16
    size: 16
    bpp: 4
    glyphsets:
      - GF_Latin_Core
  - file:
      type: gfonts
      family: Montserrat
    id: montserrat_eu_20
    size: 20
    bpp: 4
    glyphsets:
      - GF_Latin_Core
  - file:
      type: gfonts
      family: Montserrat
    id: montserrat_eu_28
    size: 28
    bpp: 4
    glyphsets:
      - GF_Latin_Core
  - file:
      type: gfonts
      family: Montserrat
    id: montserrat_eu_40
    size: 40
    bpp: 4
    glyphsets:
      - GF_Latin_Core
  - file:
      type: gfonts
      family: Montserrat
    id: montserrat_eu_48
    size: 48
    bpp: 4
    glyphsets:
      - GF_Latin_Core
  - file: "https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/heads/master/fonts/materialdesignicons-webfont.ttf"
    id: material_icons_32
    bpp: 4
    size: 32
    glyphs: [
      "\U000F0425", # mdi:power
    ]
  - file: "https://github.com/Templarian/MaterialDesign-Webfont/raw/refs/heads/master/fonts/materialdesignicons-webfont.ttf"
    id: material_icons_48
    bpp: 4
    size: 48
    glyphs: [
      "\U000F0335", # Lightbulb icon
      "\U000F0238", # Heater icon
      "\U000F050F", # mdi:thermometer
      "\U000F058E", # mdi:water-percent
      "\U000F1639", # mdi:minus-thick
      "\U000F11EC" # mdi:plus-thick
    ]
